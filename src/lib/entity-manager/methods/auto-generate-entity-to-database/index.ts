import { EntityManager } from "../..";
import { isUndefined } from "../../../utils/validations/is-undefined";
import { MetadataUtil } from "../../../utils/metadata-util";
import { shouldAutoGenerate } from "./helpers/should-auto-generate";
import { isEmptyObject } from "../../../utils/validations/is-empty-object";

interface Injectables {
	metadataManager: EntityManager<any, any>;
}

export interface AutoGenerateEntityToDatabaseParams {
	entity: any;
	data: Record<string, any>;
}

/**
 * AutoGenerate Columns Fields BEFORE the data
 * be formatted to the database pattern
 */
export const autoGenerateEntityToDatabase = (
	{ metadataManager }: Injectables,
	{ entity, data }: AutoGenerateEntityToDatabaseParams,
) => {
	if (isUndefined(data)) return {} as Record<string, any>;

	const entityMetadata = metadataManager.getEntityMetadata(entity);

	return entityMetadata.columns.reduce((acc, columnMetadata) => {
		if (MetadataUtil.isCustomMetadataType(columnMetadata.type)) {
			const subEntityMetadata = metadataManager.getEntityMetadata(
				columnMetadata.type,
			);

			const value = data[columnMetadata.name];

			const generatedValue = autoGenerateEntityToDatabase(
				{
					metadataManager,
				},
				{
					entity: subEntityMetadata,
					data: value || {},
				},
			);

			/**
			 * Only defines the new field if the autoGeneratedFields
			 * aren't just an empty object
			 */
			if (!isEmptyObject(generatedValue)) {
				acc[columnMetadata.name] = generatedValue;
			}

			return acc;
		}

		/**
		 * Is AutoGenerated Field
		 */
		if (shouldAutoGenerate(columnMetadata)) {
			// eslint-disable-next-line @typescript-eslint/no-non-null-assertion
			acc[columnMetadata.name] = columnMetadata.autoGenerate!();

			return acc;
		}

		return acc;
	}, data);
};
